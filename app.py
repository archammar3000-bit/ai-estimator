import streamlit as st
import google.generativeai as genai
import json

# ุฅุนุฏุงุฏ ุงูุตูุญุฉ
st.set_page_config(page_title="ุงูููุฏุฑ ุงูููุฏุณู ุงูุฐูู", page_icon="๐๏ธ", layout="wide")

# ูุญุงููุฉ ุฌูุจ ุงูููุชุงุญ ูู ุฅุณุฑุงุฑ ุงูููุจ
try:
    api_key = st.secrets["GOOGLE_API_KEY"]
except:
    # ุฑุณุงูุฉ ุชุธูุฑ ููุท ุฅุฐุง ูู ูุชู ูุถุน ุงูููุชุงุญ ุจุนุฏ
    st.warning("โ๏ธ ูู ูุชู ุงูุนุซูุฑ ุนูู ููุชุงุญ API. ุงูุฑุฌุงุก ุฅุถุงูุชู ูู ุฅุนุฏุงุฏุงุช Streamlit.")
    api_key = None

def get_ai_data(item, qty):
    if not api_key:
        return {"error": str(e)}
    
    genai.configure(api_key=api_key)
    model = genai.GenerativeModel('gemini-pro')
    
    prompt = f"""
    ุฃูุช ุฎุจูุฑ ุชุณุนูุฑ ููุฏุณู ุนุงููู. 
    ุงููุทููุจ: ุชุญููู ุจูุฏ "{item}"ุ ุงููููุฉ ุงูุฅุฌูุงููุฉ: {qty}.
    
    ุงูุชุจ ุงูุฑุฏ ุจุตูุบุฉ JSON Strict ููุท ุชุญุชูู ุนูู ุงูุจูุงูุงุช ุงูุชุงููุฉ (ุจุฏูู ุฃู ูุตูุต ุฅุถุงููุฉ ุฎุงุฑุฌ ุงูู JSON):
    {{
    "unit": "ูุญุฏุฉ ุงูููุงุณ ุงูููุงุณุจุฉ",
    "rate": "ุฑูู ููุซู ูุนุฏู ุงูุฅูุชุงุฌ ุงููููู ูุทุงูู ูุงุญุฏ",
    "days": "ุฑูู ููุซู ุนุฏุฏ ุงูุฃูุงู ุงููุชููุนุฉ (ุฑูู ููุท)",
    "crew": "ุชูุงุตูู ุงูุนูุงูุฉ ุงููุทููุจุฉ (ูุต)",
    "equip": "ุงููุนุฏุงุช ุงููุงุฒูุฉ (ูุต)",
    "notes": "ูุตูุญุฉ ูููุฉ ูุตูุฑุฉ"
    }}
    ุชุฃูุฏ ุฃู ุงูููุงุชูุญ ุจุงููุบุฉ ุงูุฅูุฌููุฒูุฉ ูุงูููู ุจุงููุบุฉ ุงูุนุฑุจูุฉ.
    """
    try:
        response = model.generate_content(prompt)
        # ุชูุธูู ุงููุต ูุถูุงู ุฃูู JSON ููู
        text = response.text.replace('```json', '').replace('```', '')
        return json.loads(text)
    except Exception as e:
    st.error(f"ุชูุงุตูู ุงูุฎุทุฃ ุงูุชููู: {e}")  # ูุฐุง ุงูุณุทุฑ ุณููุดู ุงูุณุจุจ
    return None

# --- ูุงุฌูุฉ ุงููููุน ---
st.title("๐๏ธ ุงููุฑุฌุน ุงูููุฏุณู ุงูุดุงูู (AI Powered)")
st.markdown("### ุฃุฏุฎู ุชูุงุตูู ุงูุจูุฏ ููููู ุงูุฐูุงุก ุงูุงุตุทูุงุนู ุจุญุณุงุจ ุงูููุงุฑุฏ ูุงูุฒูู.")
st.markdown("---")

col1, col2, col3 = st.columns([3, 1, 1])
with col1:
    item_name = st.text_input("ุงุณู ุงูุจูุฏ (ูุซุงู: ุญูุฑุ ููุงุณุฉุ ุชุฑููุจ ุฑุฎุงู)")
with col2:
    quantity = st.number_input("ุงููููุฉ", min_value=1.0, value=100.0)
with col3:
    st.write("##") # ูุณุงูุฉ
    calc_btn = st.button("ุงุญุณุจ ุงูุขู ๐", type="primary")

if calc_btn and item_name:
    with st.spinner("ุฌุงุฑู ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช ุงููุฑูุฒูุฉ ูุชุญููู ุงูุจูุฏ..."):
        data = get_ai_data(item_name, quantity)
        
        if data:
            st.success("ุชู ุงูุชุญููู ุจูุฌุงุญ!")
            
            # ุนุฑุถ ุงููุชุงุฆุฌ ุงูุนูููุฉ
            m1, m2, m3 = st.columns(3)
            m1.metric("๐ฆ ูุญุฏุฉ ุงูููุงุณ", data.get('unit', '-'))
            m2.metric("โก ุงูุฅูุชุงุฌ ุงููููู", data.get('rate', '-'))
            m3.metric("โฑ๏ธ ุงููุฏุฉ (ุทุงูู ูุงุญุฏ)", f"{data.get('days', '-')} ููู")
            
            st.markdown("---")
            
            # ุชูุงุตูู ุงูุทุงูู ูุงููุนุฏุงุช
            c1, c2 = st.columns(2)
            with c1:
                st.info(f"**๐ท ุงูุนูุงูุฉ ุงููุทููุจุฉ:**\n\n{data.get('crew', '-')}")
            with c2:
                st.warning(f"**๐ ุงููุนุฏุงุช ุงููุงุฒูุฉ:**\n\n{data.get('equip', '-')}")
                
            st.error(f"๐ **ููุงุญุธุฉ ูููุฉ:** {data.get('notes', '-')}")
            
        elif "error" in data:
            st.error(f"ุชูุงุตูู ุงูุฎุทุฃ ุงูุชููู: {data['error']}")
        else:
            st.error("ุญุฏุซ ุฎุทุฃ ุบูุฑ ูุชููุน.")
